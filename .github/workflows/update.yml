name: è‡ªåŠ¨åˆå¹¶å¹¶æ›´æ–° List æ–‡ä»¶

on:
  # æ¯å¤©è¿è¡Œä¸€æ¬¡çš„å®šæ—¶ä»»åŠ¡ï¼Œè®¾ç½®ä¸º UTC æ—¶é—´ 08:00ï¼ˆå¤§çº¦åŒ—äº¬æ—¶é—´ä¸‹åˆ 4 ç‚¹ï¼‰
  schedule:
    - cron: '0 8 * * *'
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  update-list:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æˆäºˆå†™å…¥æƒé™
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä½ çš„é¡¹ç›®ä»£ç 
        # ä½¿ç”¨ actions/checkout@v4 æ¥è·å–ä½ çš„é¡¹ç›®ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¥ ä¸‹è½½æ–‡ä»¶
        run: |
          echo "ä¸‹è½½ Gemini æ–‡ä»¶..."
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Gemini/Gemini.list -o Gemini.list
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/QuantumultX/Gemini/Gemini.list -o Gemini_qx.list

          echo "ä¸‹è½½ OpenAI æ–‡ä»¶..."
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/OpenAI/OpenAI.list -o OpenAI.list
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/QuantumultX/OpenAI/OpenAI.list -o OpenAI_qx.list

          echo "ä¸‹è½½ Claude æ–‡ä»¶..."
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/Clash/Claude/Claude.list -o Claude.list
          curl -sS https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/refs/heads/master/rule/QuantumultX/Claude/Claude.list -o Claude_qx.list

          echo "ä¸‹è½½ Web3 æ–‡ä»¶..."
          curl -sS https://raw.githubusercontent.com/enriquephl/QuantumultX_config/refs/heads/main/ClashRuleSet/Clash/Web3.list -o Web3.list

      - name: ğŸ“ åˆå¹¶æ–‡ä»¶
        run: |
          echo "æ­£åœ¨åˆå¹¶ Clash è§„åˆ™..."
          for f in Gemini.list OpenAI.list Claude.list; do
            if [ -s "$f" ]; then
              cat "$f" >> clash/ai.list
            else
              echo "âš ï¸ $f ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

          echo "åˆå¹¶ QuantumultX è§„åˆ™..."
          for f in Gemini_qx.list OpenAI_qx.list Claude_qx.list; do
            if [ -s "$f" ]; then
              cat "$f" >> quantumultx/ai.list
            else
              echo "âš ï¸ $f ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡"
            fi
          done

          echo "åˆå¹¶ Web3 è§„åˆ™..."
          if [ -s "Web3.list" ]; then
            cat "Web3.list" >> clash/crypto.list
            cat "Web3.list" >> quantumultx/crypto.list
          else
            echo "âš ï¸ Web3.list ä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi



      - name: ğŸ—‘ï¸ åˆ é™¤æ–‡ä»¶
        run: |
          echo "æ­£åœ¨åˆ é™¤ä¸´æ—¶æ–‡ä»¶..."
          rm Gemini.list OpenAI.list Claude.list Gemini_qx.list OpenAI_qx.list Claude_qx.list

      - name: ğŸ“¦ é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        # è¿™ä¸€æ­¥æ˜¯è®© Action èƒ½å¤Ÿä»¥æ­£ç¡®çš„èº«ä»½æäº¤ä»£ç 
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: ğŸ“¤ æ£€æŸ¥å¹¶æäº¤æ›´æ–°
        # æ£€æŸ¥ list æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæœ‰å˜åŒ–åˆ™æäº¤å¹¶æ¨é€
        # --allow-empty é¿å…æ²¡æœ‰ä¿®æ”¹æ—¶å¯¼è‡´è„šæœ¬æŠ¥é”™
        run: |
          FILES=(
            clash/ai.list
            clash/crypto.list
            quantumultx/ai.list
            quantumultx/crypto.list
          )

          if git diff --quiet -- "${FILES[@]}"; then
            echo "æ–‡ä»¶æ²¡æœ‰å˜åŠ¨ï¼Œè·³è¿‡æäº¤"
          else
            echo "æ–‡ä»¶å·²æ›´æ–°ï¼Œæ­£åœ¨æäº¤..."
            git add "${FILES[@]}"
            git commit -m "chore(list): Auto update list [skip ci]"
            git push
            echo "æ–‡ä»¶æ›´æ–°å¹¶æ¨é€å®Œæˆã€‚"
          fi